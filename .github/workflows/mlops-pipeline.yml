name: MLOps CI Pipeline - Automated Training & Artifact Management

# Trigger the workflow on pushes to the main branch or manual dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  model-orchestration:
    name: Model Training and Lifecycle Management
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Clone the repository to the GitHub runner environment
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # Step 2: Initialize a clean Python runtime environment
      - name: Provision Python 3.11 Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Step 3: Install project dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Execute the core MLOps pipeline
      # We added a command to create the specific folder your code expects
      - name: Execute End-to-End Pipeline
        env: 
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          python run_pipeline.py
          # Create the directory expected by the API/Gradio code
          mkdir -p diabetes-model-artifacts
          # Copy generated pkl files from artifacts/ to the new directory
          cp -r artifacts/* diabetes-model-artifacts/

      # Step 5: Persist binary artifacts to GitHub storage
      # Updated path to match the new directory name
      - name: Archive Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: diabetes-model-artifacts
          path: diabetes-model-artifacts/
          retention-days: 7

      # Step 6: Login to Docker Hub
      - name: Login to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}    
          
      # Step 7: Build and Push Docker Image
      # The 'context: .' ensures the 'diabetes-model-artifacts' folder is included in the image
      - name: Build and Push Docker Image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true 
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/diabetes-mlops:latest
