name: MLOps CI Pipeline - Automated Training & Artifact Management

# Trigger the workflow on pushes to the main branch or manual dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  model-orchestration:
    name: Model Training and Lifecycle Management
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Clone the repository to the GitHub runner environment
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # Step 2: Initialize a clean Python runtime environment (Matching local/prod specs)
      - name: Provision Python 3.11 Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Step 3: Install project dependencies defined in requirements.txt
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Execute the core MLOps pipeline
      # Injects MLflow/DagsHub credentials via secure environment variables for remote tracking
      - name: Execute End-to-End Pipeline
        env: 
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: python run_pipeline.py
        
      # Step 5: Persist generated binary artifacts (Models, Scalers) to GitHub storage
      # This ensures artifact traceability and accessibility for downstream tasks
      - name: Archive Model Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: diabetes-model-artifacts
          path: artifacts/
          retention-days: 7
      # step 6: connect with Docker    
      - name: Login to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}    
          
      # Step 7: Validate build integrity by containerizing the application
      # Note: 'push' is set to false as a safety gate before official deployment
      - name: Build and Validate Docker Image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true 
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/diabetes-mlops:latest
